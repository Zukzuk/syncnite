tags:
  - name: App
  - name: Extension
  - name: Accounts
  - name: Playnite

components:
  securitySchemes:
    XAuthEmail:
      type: apiKey
      in: header
      name: x-auth-email
      description: Admin/user email for header auth
    XAuthPassword:
      type: apiKey
      in: header
      name: x-auth-password
      description: Admin/user password for header auth
    XClientId:
      type: apiKey
      in: header
      name: x-client-id
      description: Unique client ID for admin locking
  schemas:
    ErrorResponse:
      type: object
      properties:
        ok: { type: boolean }
        error: { type: string }
    AuthInfo:
      type: object
      properties:
        email: { type: string }
        role:
          type: string
          enum: [admin, user, unknown]
    InstalledPush:
      type: object
      properties:
        installed:
          type: array
          items: { type: string }
      required: [installed]
    DeltaRequest:
      type: object
      properties:
        json:
          type: object
          additionalProperties:
            type: array
            items: { type: string }
        versions:
          type: object
          nullable: true
          description: >
            Optional per-entity metadata versions, keyed by collection then id.
            Example: { "games": { "<id>": "<ticks>" }, ... }.
          additionalProperties:
            type: object
            additionalProperties:
              type: string
              description: Client metadata version for the entity.
        installed:
          type: object
          nullable: true
          properties:
            count: { type: integer }
            hash: { type: string }
    DeltaResponse:
      type: object
      properties:
        ok: { type: boolean }
        delta:
          type: object
          properties:
            toUpsert:
              type: object
              additionalProperties:
                type: array
                items: { type: string }
            toDelete:
              type: object
              additionalProperties:
                type: array
                items: { type: string }
    EntityBody:
      type: object
      additionalProperties: true
    SteamProfile:
      type: object
      description: Basic profile data returned by Steam OpenID helper
      properties:
        personaname:
          type: string
          nullable: true
        avatar:
          type: string
          format: uri
          nullable: true
        avatarfull:
          type: string
          format: uri
          nullable: true
        profileurl:
          type: string
          format: uri
          nullable: true
    SteamConnection:
      type: object
      description: Steam link info stored on the Syncnite account
      properties:
        steamId:
          type: string
          description: SteamID64
        linkedAt:
          type: string
          format: date-time
          description: When this Steam account was linked
    SteamWishlistItemDetails:
      type: object
      description: Hydrated store details for a Steam app
      properties:
        appid:
          type: integer
        name:
          type: string
        type:
          type: string
          nullable: true
        headerImage:
          type: string
          format: uri
          nullable: true
        price:
          type: object
          nullable: true
          properties:
            currency: { type: string }
            initial:
              type: integer
              description: Price in minor units (e.g. cents)
            final:
              type: integer
              description: Discounted price in minor units (e.g. cents)
            discountPercent:
              type: integer
        releaseDate:
          type: object
          nullable: true
          properties:
            date:
              type: string
            comingSoon:
              type: boolean
    SteamWishlistItem:
      type: object
      description: Wishlist entry with optional hydrated game details
      properties:
        appid:
          type: integer
        priority:
          type: integer
        dateAdded:
          type: string
          format: date-time
        details:
          $ref: "#/components/schemas/SteamWishlistItemDetails"
    SteamWishlistSnapshot:
      type: object
      description: Last synced wishlist snapshot for an account
      properties:
        lastSynced:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: "#/components/schemas/SteamWishlistItem"

paths:

# App endpoints

  /ping:
    get:
      tags: [App]
      summary: Ping API
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  version: { type: string }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /ping/status:
    get:
      tags: [App]
      summary: Extension ping status
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  connected: { type: boolean }
                  lastPingAt:
                    type: string
                    format: date-time
                    nullable: true
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (session required)
        
  /sse:
    get:
      tags: [App]
      summary: Server-Sent Events (logs/progress)
      description: Text/event-stream channel used by the web app.
      responses:
        "200":
          description: Event stream

  /log:
    post:
      tags: [App]
      summary: Client log upload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              # Single object or array of objects; server ignores unknown fields.
              oneOf:
                - type: object
                  additionalProperties: true
                - type: array
                  items:
                    type: object
                    additionalProperties: true
      responses:
        "204":
          description: Accepted
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

# Extension endpoints

  /extension/download:
    get:
      tags: [Extension]
      summary: Download the Syncnite Bridge extension package
      responses:
        "200":
          description: Package stream
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

# Accounts endpoints

  /accounts/register/admin:
    post:
      tags: [Accounts]
      summary: Register first admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
              required: [email, password]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        "400":
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Admin exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
                
  /accounts/admin/release:
    post:
      tags: [Accounts]
      summary: Release admin client lock
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/register/user:
    post:
      tags: [Accounts]
      summary: Register user (requires an existing admin)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
              required: [email, password]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        "400":
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: No admin yet
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: User exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/login:
    post:
      tags: [Accounts]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
              required: [email, password]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  email: { type: string }
                  role:
                    type: string
                    enum: [admin, user, unknown]
        "400":
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/status:
    get:
      tags: [Accounts]
      summary: Whether any admin exists
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasAdmin: { type: boolean }

  /accounts/verify:
    get:
      tags: [Accounts]
      summary: Verify user session
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthInfo"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/verify/admin:
    get:
      tags: [Accounts]
      summary: Verify admin session
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthInfo"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

# Playnite endpoints

  /playnite/installed:
    post:
      tags: [Playnite]
      summary: Push installed game IDs (minimal)
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InstalledPush"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  count: { type: integer }
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /playnite/delta:
    post:
      tags: [Playnite]
      summary: Compute server delta
      description: >
        Compute the delta between client-known ids and server state, optionally
        using per-entity metadata versions to narrow upserts.
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeltaRequest"
      responses:
        "200":
          description: Delta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeltaResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /playnite/snapshot:
    post:
      tags: [Playnite]
      summary: Push full snapshot
      description: >
        Push a full snapshot object for the current user. The server stores it
        as `snapshot/snapshot.json` and annotates it with audit metadata
        (updatedAt, source, pushedBy, serverUpdatedAt).
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityBody"
      responses:
        "200":
          description: Snapshot stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        "400":
          description: Bad request (invalid snapshot or missing email)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /playnite/collection/{collection}:
    get:
      tags: [Playnite]
      summary: List all entities in a collection
      description: >
        Returns all JSON rows for the given collection from the server-side
        database. The result is a deterministically sorted array.
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      parameters:
        - name: collection
          in: path
          required: true
          schema:
            type: string
            enum:
              - games
              - companies
              - tags
              - sources
              - platforms
              - genres
              - categories
              - features
              - series
              - regions
              - ageratings
              - completionstatuses
              - filterpresets
              - importexclusions
      responses:
        "200":
          description: Collection items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/EntityBody"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /playnite/{collection}/{id}:
    parameters:
      - name: collection
        in: path
        required: true
        schema:
          type: string
          enum:
            - games
            - companies
            - tags
            - sources
            - platforms
            - genres
            - categories
            - features
            - series
            - regions
            - ageratings
            - completionstatuses
            - filterpresets
            - importexclusions
      - name: id
        in: path
        required: true
        schema:
          type: string

    put:
      tags: [Playnite]
      summary: Upsert entity (idempotent)
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityBody"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  id: { type: string }
                  collection: { type: string }
                  created: { type: boolean }
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  id: { type: string }
                  collection: { type: string }
                  created: { type: boolean }
        "204":
          description: No change (payload identical)
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags: [Playnite]
      summary: Delete entity (idempotent)
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "204":
          description: Deleted or absent
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /playnite/media/{path}:
    parameters:
      - name: path
        in: path
        required: true
        schema:
          type: string
          description: >
            Relative path under the media root (libraryfiles). Encode slashes if
            tooling cannot send wildcard segments (e.g. `%2F`).
    get:
      tags: [Playnite]
      summary: Download media (binary)
      description: >
        Download a media file from the libraryfiles tree. The `path` is the
        relative path under the media root. Encode slashes in `{path}` if your
        tooling cannot send wildcard path segments (e.g. `%2F`).
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: Media file stream
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Error streaming media
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      tags: [Playnite]
      summary: Upload media (binary)
      description: >
        Upload a media file into the libraryfiles tree. **Note:** encode slashes in
        `{path}` if your tooling cannot send wildcard path segments (e.g. `%2F`).
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  bytes: { type: integer, description: "Bytes written" }
        "200":
          description: Overwritten
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  bytes: { type: integer, description: "Bytes written" }
        "204":
          description: No change (size/hash match)
        "400":
          description: Invalid path or empty body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (admin required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

# Steam endpoints

  /steam:
    get:
      tags: [Steam]
      summary: Get Steam link status for current account
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: Steam link status
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  connected:
                    type: boolean
                  steam:
                    allOf:
                      - $ref: "#/components/schemas/SteamConnection"
                    nullable: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Account not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /steam/link:
    post:
      tags: [Steam]
      summary: Link a Steam account to the current Syncnite account
      description: >
        Links the given SteamID64 to the currently authenticated Syncnite
        account. Typically called after a successful /steam/auth/callback.
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                steamId:
                  type: string
                  description: SteamID64 obtained from /steam/auth/callback
              required: [steamId]
      responses:
        "200":
          description: Steam account linked
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  steam:
                    $ref: "#/components/schemas/SteamConnection"
        "400":
          description: Missing or invalid SteamID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to persist Steam connection
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /steam/auth:
    get:
      tags: [Steam]
      summary: Start Steam login (OpenID)
      description: >
        Redirects the browser to Steam's OpenID login page. This endpoint does
        not require Syncnite authentication and is typically called by the web
        app to start the "Sign in through Steam" flow.
      responses:
        "302":
          description: Redirect to Steam OpenID login
        "500":
          description: Failed to construct redirect
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /steam/auth/callback:
    get:
      tags: [Steam]
      summary: Steam OpenID callback
      description: >
        Callback endpoint for Steam OpenID. Steam redirects the user here after
        login. Returns the SteamID64 and basic profile information.
      responses:
        "200":
          description: Authenticated Steam user info
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  steamId:
                    type: string
                    description: SteamID64 of the authenticated user
                  profile:
                    $ref: "#/components/schemas/SteamProfile"
        "401":
          description: OpenID validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /steam/wishlist:
    get:
      tags: [Steam]
      summary: Get last synced Steam wishlist snapshot
      description: >
        Returns the last synced Steam wishlist snapshot for the current
        account, loaded from the per-account `/steam/<email>.<role>.json` file.
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: Wishlist snapshot
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  lastSynced:
                    type: string
                    format: date-time
                    nullable: true
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/SteamWishlistItem"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Account not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /steam/wishlist/sync:
    post:
      tags: [Steam]
      summary: Sync Steam wishlist from Steam into Syncnite storage
      description: >
        Fetches the wishlist for the linked Steam account via the Steam Web API
        and stores a snapshot on the server under a per-account steam file.
      security:
        - XAuthEmail: []
          XAuthPassword: []
          XClientId: []
      responses:
        "200":
          description: Wishlist synced and snapshot stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  count:
                    type: integer
                    description: Number of wishlist entries in the snapshot
                  lastSynced:
                    type: string
                    format: date-time
        "400":
          description: Steam not linked or Steam API error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to persist snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

